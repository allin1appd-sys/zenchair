import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Image,
  Dimensions,
  ActivityIndicator
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { useTheme } from '../../src/theme';
import { Ionicons } from '@expo/vector-icons';
import axios from 'axios';

const { width } = Dimensions.get('window');

export default function ShopDetailScreen() {
  const { id } = useLocalSearchParams();
  const { theme } = useTheme();
  const router = useRouter();
  
  const [shop, setShop] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'services' | 'products' | 'reviews' | 'info'>('services');
  const [isFavorite, setIsFavorite] = useState(false);
  const [currentImageIndex, setCurrentImageIndex] = useState(0);

  useEffect(() => {
    fetchShopDetails();
    checkFavorite();
  }, [id]);

  const fetchShopDetails = async () => {
    try {
      const response = await axios.get(`/barbers/shops/${id}`);
      setShop(response.data);
    } catch (error) {
      console.error('Error fetching shop:', error);
    } finally {
      setLoading(false);
    }
  };

  const checkFavorite = async () => {
    try {
      const response = await axios.get('/favorites');
      const favoriteIds = response.data.map((f: any) => f._id);
      setIsFavorite(favoriteIds.includes(id));
    } catch (error) {
      console.error('Error checking favorite:', error);
    }
  };

  const toggleFavorite = async () => {
    try {
      if (isFavorite) {
        await axios.delete(`/favorites/${id}`);
        setIsFavorite(false);
      } else {
        await axios.post('/favorites', { shop_id: id });
        setIsFavorite(true);
      }
    } catch (error) {
      console.error('Error toggling favorite:', error);
    }
  };

  if (loading) {
    return (\n      <SafeAreaView style={[styles.container, { backgroundColor: theme.background }]}>\n        <View style={styles.loadingContainer}>\n          <ActivityIndicator size=\"large\" color={theme.primary} />\n        </View>\n      </SafeAreaView>\n    );\n  }\n\n  if (!shop) {\n    return (\n      <SafeAreaView style={[styles.container, { backgroundColor: theme.background }]}>\n        <View style={styles.errorContainer}>\n          <Text style={[styles.errorText, { color: theme.text }]}>Shop not found</Text>\n        </View>\n      </SafeAreaView>\n    );\n  }\n\n  const renderServices = () => (\n    <View style={styles.tabContent}>\n      {shop.services?.length === 0 ? (\n        <Text style={[styles.emptyText, { color: theme.textSecondary }]}>\n          No services available\n        </Text>\n      ) : (\n        shop.services?.map((service: any) => (\n          <View key={service._id} style={[styles.serviceCard, { backgroundColor: theme.surface }]}>\n            <View style={styles.serviceHeader}>\n              <Text style={[styles.serviceName, { color: theme.text }]}>\n                {service.name}\n              </Text>\n              <Text style={[styles.servicePrice, { color: theme.primary }]}>\n                \u20aa{service.price}\n              </Text>\n            </View>\n            <Text style={[styles.serviceDescription, { color: theme.textSecondary }]}>\n              {service.description}\n            </Text>\n            <Text style={[styles.serviceDuration, { color: theme.textTertiary }]}>\n              {service.duration} minutes\n            </Text>\n          </View>\n        ))\n      )}\n    </View>\n  );\n\n  const renderProducts = () => (\n    <View style={styles.tabContent}>\n      {shop.products?.length === 0 ? (\n        <Text style={[styles.emptyText, { color: theme.textSecondary }]}>\n          No products available\n        </Text>\n      ) : (\n        shop.products?.map((product: any) => (\n          <View key={product._id} style={[styles.productCard, { backgroundColor: theme.surface }]}>\n            {product.image && (\n              <Image\n                source={{ uri: product.image }}\n                style={styles.productImage}\n              />\n            )}\n            <View style={styles.productInfo}>\n              <Text style={[styles.productName, { color: theme.text }]}>\n                {product.name}\n              </Text>\n              <Text style={[styles.productDescription, { color: theme.textSecondary }]}>\n                {product.description}\n              </Text>\n              <Text style={[styles.productPrice, { color: theme.primary }]}>\n                \u20aa{product.price}\n              </Text>\n            </View>\n          </View>\n        ))\n      )}\n    </View>\n  );\n\n  const renderReviews = () => (\n    <View style={styles.tabContent}>\n      {shop.reviews?.length === 0 ? (\n        <Text style={[styles.emptyText, { color: theme.textSecondary }]}>\n          No reviews yet\n        </Text>\n      ) : (\n        shop.reviews?.map((review: any) => (\n          <View key={review._id} style={[styles.reviewCard, { backgroundColor: theme.surface }]}>\n            <View style={styles.reviewHeader}>\n              <Text style={[styles.reviewerName, { color: theme.text }]}>\n                {review.customer_name}\n              </Text>\n              <View style={styles.reviewRating}>\n                {[...Array(5)].map((_, i) => (\n                  <Ionicons\n                    key={i}\n                    name={i < review.rating ? 'star' : 'star-outline'}\n                    size={14}\n                    color=\"#FFB800\"\n                  />\n                ))}\n              </View>\n            </View>\n            <Text style={[styles.reviewComment, { color: theme.textSecondary }]}>\n              {review.comment}\n            </Text>\n          </View>\n        ))\n      )}\n    </View>\n  );\n\n  const renderInfo = () => (\n    <View style={styles.tabContent}>\n      <View style={[styles.infoCard, { backgroundColor: theme.surface }]}>\n        <View style={styles.infoRow}>\n          <Ionicons name=\"location\" size={20} color={theme.primary} />\n          <Text style={[styles.infoText, { color: theme.text }]}>\n            {shop.location.address}, {shop.location.city}\n          </Text>\n        </View>\n        <View style={styles.infoRow}>\n          <Ionicons name=\"call\" size={20} color={theme.primary} />\n          <Text style={[styles.infoText, { color: theme.text }]}>\n            {shop.phone}\n          </Text>\n        </View>\n        {shop.email && (\n          <View style={styles.infoRow}>\n            <Ionicons name=\"mail\" size={20} color={theme.primary} />\n            <Text style={[styles.infoText, { color: theme.text }]}>\n              {shop.email}\n            </Text>\n          </View>\n        )}\n      </View>\n\n      <View style={[styles.hoursCard, { backgroundColor: theme.surface }]}>\n        <Text style={[styles.hoursTitle, { color: theme.text }]}>Working Hours</Text>\n        {shop.working_hours?.map((wh: any, idx: number) => (\n          <View key={idx} style={styles.hourRow}>\n            <Text style={[styles.dayText, { color: theme.text }]}>\n              {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][wh.day]}\n            </Text>\n            <Text style={[styles.timeText, { color: theme.textSecondary }]}>\n              {wh.is_closed ? 'Closed' : `${wh.open_time} - ${wh.close_time}`}\n            </Text>\n          </View>\n        ))}\n      </View>\n    </View>\n  );\n\n  return (\n    <SafeAreaView style={[styles.container, { backgroundColor: theme.background }]} edges={['top']}>\n      {/* Header */}\n      <View style={[styles.header, { backgroundColor: theme.surface }]}>\n        <TouchableOpacity onPress={() => router.back()}>\n          <Ionicons name=\"arrow-back\" size={24} color={theme.text} />\n        </TouchableOpacity>\n        <TouchableOpacity onPress={toggleFavorite}>\n          <Ionicons\n            name={isFavorite ? 'heart' : 'heart-outline'}\n            size={24}\n            color={isFavorite ? '#F44336' : theme.text}\n          />\n        </TouchableOpacity>\n      </View>\n\n      <ScrollView>\n        {/* Gallery */}\n        <View style={styles.galleryContainer}>\n          {shop.gallery_images?.length > 0 ? (\n            <ScrollView\n              horizontal\n              pagingEnabled\n              showsHorizontalScrollIndicator={false}\n              onScroll={(e) => {\n                const index = Math.round(e.nativeEvent.contentOffset.x / width);\n                setCurrentImageIndex(index);\n              }}\n              scrollEventThrottle={16}\n            >\n              {shop.gallery_images.map((img: string, idx: number) => (\n                <Image\n                  key={idx}\n                  source={{ uri: img }}\n                  style={styles.galleryImage}\n                />\n              ))}\n            </ScrollView>\n          ) : (\n            <View style={[styles.placeholderGallery, { backgroundColor: theme.surface }]}>\n              <Ionicons name=\"image-outline\" size={48} color={theme.textTertiary} />\n            </View>\n          )}\n          {shop.gallery_images?.length > 0 && (\n            <View style={styles.pagination}>\n              {shop.gallery_images.map((_: any, idx: number) => (\n                <View\n                  key={idx}\n                  style={[\n                    styles.paginationDot,\n                    idx === currentImageIndex && styles.paginationDotActive\n                  ]}\n                />\n              ))}\n            </View>\n          )}\n        </View>\n\n        {/* Shop Info */}\n        <View style={styles.shopInfoContainer}>\n          <View style={styles.shopMainInfo}>\n            <Text style={[styles.shopTitle, { color: theme.text }]}>\n              {shop.name}\n            </Text>\n            <View style={styles.shopMetaRow}>\n              <View style={styles.ratingContainer}>\n                <Ionicons name=\"star\" size={16} color=\"#FFB800\" />\n                <Text style={[styles.ratingValue, { color: theme.text }]}>\n                  {shop.rating.toFixed(1)}\n                </Text>\n                <Text style={[styles.reviewCount, { color: theme.textSecondary }]}>\n                  ({shop.total_reviews} reviews)\n                </Text>\n              </View>\n              <View style={[\n                styles.openBadge,\n                { backgroundColor: shop.is_open ? '#4CAF50' : '#F44336' }\n              ]}>\n                <Text style={styles.openText}>\n                  {shop.is_open ? 'Open' : 'Closed'}\n                </Text>\n              </View>\n            </View>\n            <Text style={[styles.shopLocation, { color: theme.textSecondary }]}>\n              {shop.location.city}\n            </Text>\n          </View>\n\n          <Text style={[styles.shopDescription, { color: theme.text }]}>\n            {shop.description}\n          </Text>\n        </View>\n\n        {/* Tabs */}\n        <View style={[styles.tabsContainer, { borderBottomColor: theme.border }]}>\n          {['services', 'products', 'reviews', 'info'].map((tab) => (\n            <TouchableOpacity\n              key={tab}\n              style={[\n                styles.tab,\n                activeTab === tab && { borderBottomColor: theme.primary }\n              ]}\n              onPress={() => setActiveTab(tab as any)}\n            >\n              <Text\n                style={[\n                  styles.tabText,\n                  { color: activeTab === tab ? theme.primary : theme.textSecondary }\n                ]}\n              >\n                {tab.charAt(0).toUpperCase() + tab.slice(1)}\n              </Text>\n            </TouchableOpacity>\n          ))}\n        </View>\n\n        {/* Tab Content */}\n        {activeTab === 'services' && renderServices()}\n        {activeTab === 'products' && renderProducts()}\n        {activeTab === 'reviews' && renderReviews()}\n        {activeTab === 'info' && renderInfo()}\n      </ScrollView>\n\n      {/* Book Now Button */}\n      <View style={[styles.footer, { backgroundColor: theme.surface }]}>\n        <TouchableOpacity\n          style={[styles.bookButton, { backgroundColor: theme.primary }]}\n          onPress={() => router.push(`/booking/${id}`)}\n        >\n          <Ionicons name=\"calendar\" size={20} color=\"#FFF\" />\n          <Text style={styles.bookButtonText}>Book Now</Text>\n        </TouchableOpacity>\n      </View>\n    </SafeAreaView>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1\n  },\n  header: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    padding: 16\n  },\n  galleryContainer: {\n    height: 250,\n    position: 'relative'\n  },\n  galleryImage: {\n    width,\n    height: 250\n  },\n  placeholderGallery: {\n    width,\n    height: 250,\n    justifyContent: 'center',\n    alignItems: 'center'\n  },\n  pagination: {\n    position: 'absolute',\n    bottom: 16,\n    left: 0,\n    right: 0,\n    flexDirection: 'row',\n    justifyContent: 'center',\n    gap: 6\n  },\n  paginationDot: {\n    width: 6,\n    height: 6,\n    borderRadius: 3,\n    backgroundColor: 'rgba(255,255,255,0.5)'\n  },\n  paginationDotActive: {\n    backgroundColor: '#FFF',\n    width: 20\n  },\n  shopInfoContainer: {\n    padding: 16\n  },\n  shopMainInfo: {\n    marginBottom: 12\n  },\n  shopTitle: {\n    fontSize: 24,\n    fontWeight: 'bold',\n    marginBottom: 8\n  },\n  shopMetaRow: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'space-between',\n    marginBottom: 8\n  },\n  ratingContainer: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 6\n  },\n  ratingValue: {\n    fontSize: 16,\n    fontWeight: '600'\n  },\n  reviewCount: {\n    fontSize: 14\n  },\n  openBadge: {\n    paddingHorizontal: 12,\n    paddingVertical: 6,\n    borderRadius: 12\n  },\n  openText: {\n    color: '#FFF',\n    fontSize: 12,\n    fontWeight: '600'\n  },\n  shopLocation: {\n    fontSize: 14\n  },\n  shopDescription: {\n    fontSize: 15,\n    lineHeight: 22\n  },\n  tabsContainer: {\n    flexDirection: 'row',\n    borderBottomWidth: 1,\n    marginHorizontal: 16\n  },\n  tab: {\n    flex: 1,\n    paddingVertical: 12,\n    alignItems: 'center',\n    borderBottomWidth: 2,\n    borderBottomColor: 'transparent'\n  },\n  tabText: {\n    fontSize: 14,\n    fontWeight: '600'\n  },\n  tabContent: {\n    padding: 16\n  },\n  serviceCard: {\n    padding: 16,\n    borderRadius: 12,\n    marginBottom: 12\n  },\n  serviceHeader: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 8\n  },\n  serviceName: {\n    fontSize: 16,\n    fontWeight: '600'\n  },\n  servicePrice: {\n    fontSize: 18,\n    fontWeight: 'bold'\n  },\n  serviceDescription: {\n    fontSize: 14,\n    marginBottom: 6\n  },\n  serviceDuration: {\n    fontSize: 12\n  },\n  productCard: {\n    flexDirection: 'row',\n    padding: 12,\n    borderRadius: 12,\n    marginBottom: 12,\n    gap: 12\n  },\n  productImage: {\n    width: 80,\n    height: 80,\n    borderRadius: 8\n  },\n  productInfo: {\n    flex: 1\n  },\n  productName: {\n    fontSize: 16,\n    fontWeight: '600',\n    marginBottom: 4\n  },\n  productDescription: {\n    fontSize: 14,\n    marginBottom: 6\n  },\n  productPrice: {\n    fontSize: 16,\n    fontWeight: 'bold'\n  },\n  reviewCard: {\n    padding: 16,\n    borderRadius: 12,\n    marginBottom: 12\n  },\n  reviewHeader: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 8\n  },\n  reviewerName: {\n    fontSize: 16,\n    fontWeight: '600'\n  },\n  reviewRating: {\n    flexDirection: 'row',\n    gap: 2\n  },\n  reviewComment: {\n    fontSize: 14,\n    lineHeight: 20\n  },\n  infoCard: {\n    padding: 16,\n    borderRadius: 12,\n    marginBottom: 12,\n    gap: 12\n  },\n  infoRow: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 12\n  },\n  infoText: {\n    fontSize: 15,\n    flex: 1\n  },\n  hoursCard: {\n    padding: 16,\n    borderRadius: 12,\n    gap: 8\n  },\n  hoursTitle: {\n    fontSize: 16,\n    fontWeight: '600',\n    marginBottom: 8\n  },\n  hourRow: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    paddingVertical: 6\n  },\n  dayText: {\n    fontSize: 14,\n    fontWeight: '600'\n  },\n  timeText: {\n    fontSize: 14\n  },\n  emptyText: {\n    fontSize: 16,\n    textAlign: 'center',\n    paddingVertical: 32\n  },\n  footer: {\n    padding: 16,\n    borderTopWidth: 1,\n    borderTopColor: '#E0E0E0'\n  },\n  bookButton: {\n    height: 56,\n    borderRadius: 12,\n    flexDirection: 'row',\n    justifyContent: 'center',\n    alignItems: 'center',\n    gap: 8\n  },\n  bookButtonText: {\n    color: '#FFF',\n    fontSize: 18,\n    fontWeight: '600'\n  },\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center'\n  },\n  errorContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center'\n  },\n  errorText: {\n    fontSize: 18\n  }\n});\n